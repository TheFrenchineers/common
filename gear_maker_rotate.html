<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        #wrapper {
            height: 100%;
            width: 100%;
            display: flex;
        }

        #input {
            box-shadow: 1px 0px 5px;
            height: 100%;
            width: min-content;
            overflow-y: scroll;
        }

        #content {
            margin: 10px;
        }

        hr {
            border: 1.5px dashed black;
        }

        button {
            cursor: pointer;
        }

        #wrap2 {
            width: -webkit-fill-available;
            display: flex;
            justify-content: center;
            width: inherit;
            flex-direction: column;
        }

        line {
            stroke: #000;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div id="input">
            <div id="content">
                <h3>2D View</h3>
                Number of teeth: <input id="teethN" value="15" placeholder="int"><br><br>
                Teeth size: <input id="teethS" value="3.5" placeholder="float"><br><br>
                Gear radius: <input id="radius" value="18" placeholder="float"><br><br>
                Function: <input id="fn" value="default_fn" placeholder="f = x :float => () -> float"
                    title="default/trianle/square/cos"><br><br>
                Precision: <input id="precision" value="1000" placeholder="int"><br><br>
                <button title="save SVG"
                    onclick="const a = document.createElement('a');a.href = 'data:text/stl;utf-8,' + encodeURIComponent(svg.outerHTML);a.download = `gear_T${teeth_N}S${teeth_S}.svg`;a.click();">save
                    2D graphic</button>
                <hr>
                <h3>3D View</h3>
                Height: <input id="height" value="10" placeholder="float"><br><br>
                Angle: <input id="angle" value="0" placeholder="float"><br><br>
                Height Precision: <input id="hprecision" value="1" placeholder="int"><br><br>
                <button title="save STL"
                    onclick="const a = document.createElement('a');a.href = 'data:image/stl;utf-8,' + encodeURIComponent(toSTL());a.download = `gear_T${teeth_N}S${teeth_S}.stl`;a.click();">save
                    3D shape</button>
            </div>
        </div>
        <div id="wrap2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -20 100 40" id="svg_fn">
                <line x1="0" x2="100" y1="-10" y2="-10" stroke-width=".2" />
                <line x1="0" x2="100" stroke-width=".3" />
                <line x1="0" x2="100" y1="10" y2="10" stroke-width=".2" />
                <path fill="none" stroke="#f00" stroke-width=".3" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="-50 -10 100 20" id="svg_gear">
                <path />
            </svg>
        </div>
    </div>
    </div>
    <script>
        const $ = (s, p = document) => p.querySelector(s);
        const svg = $('#svg_gear');
        const path = $('path', svg);
        const svgf = $('#svg_fn');
        const pathf = $('path', svgf);
        const default_fn = x => (b = (x / Math.PI / 2 * teeth_N) % 1 * 7, (b < 1 ? 1 - (b - 1) ** 2 : b < 3 ? 1 : b < 4 ? 1 - (b - 3) ** 2 : -Math.sqrt(1.5 ** 2 - (b - 5.5) ** 2) * .2) * teeth_S);
        const triangle_fn = x => (b = (x / Math.PI * teeth_N) % 1, (b < .5 ? b * 4 - 1 : 3 - b * 4) * teeth_S);
        const cos_fn = x => Math.cos(x * teeth_N) * teeth_S;
        const square_fn = x => (b = (x / Math.PI * teeth_N / 2) % 1, (b < .5 ? 1 : -1) * teeth_S);
        var teeth_N = 15;
        var teeth_S = 3.5;
        var precision = 1000;
        var scale = 1;
        var r = 18;
        var func = default_fn;//x => Math.max(Math.cos(x * teeth_N), 0) * teeth_S;
        var run = () => {
            svg.setAttribute('viewBox', `${-r - teeth_S} ${-r - teeth_S} ${(r + teeth_S) * 2} ${(r + teeth_S) * 2}`)
            var str = '';
            for (let d = 0; d < precision; d++) {
                const i = d * Math.PI * 2 / precision;
                const j = func(i) + r;
                str += (i ? ' L ' : 'M ') + Math.cos(i) * j + ',' + Math.sin(i) * j;
            }
            path.setAttribute('d', str + ' z');
        }
        String.prototype.splice = function (index, rem, str) {
            return this.slice(0, index) + str + this.slice(index + Math.abs(rem));
        };
        function show_fn() {
            var str = "M";
            for (let d = 0; d < precision + 1; d++) str += ` ${d / precision * 100},${-10 * func(d * Math.PI * 2 / precision) / teeth_S}`;
            pathf.setAttribute('d', str);
        }
        function numbertoSTL(n) {
            if (n === 0) return '0.00000E+000';
            const s = Math.sign(n);
            const k = Math.floor(Math.log10(Math.abs(n)));
            n *= 10 ** -k;
            n = (Math.round(n * 1e5) * 1e-5).toString()
            if (n.length === (s === -1 ? 2 : 1)) n += '.00000';
            else for (let i = n.length; i < (s === -1 ? 8 : 7); i++) n += '0';
            var k_txt = Math.abs(k).toString();
            while (k_txt.length < 3) k_txt = '0' + k_txt;
            if (k >= 3) console.log(n)
            return `${n.slice(0, (s === -1 ? 8 : 7))}E${k < 0 ? '-' : '+'}${k_txt}`
        }
        const vertexText = point => `            vertex ${point.map(numbertoSTL).join(' ')}`;
        const vertexText_xxx = point => `            vertex ${point.join(' ')}`;
        function get_points(height, rotate, precision_height) {
            const points = [];
            for (let k = 0; k < precision_height + 1; k++) {
                const z = k * height / precision_height;
                const txtZ = numbertoSTL(z);
                const rot = k * rotate / precision_height;
                const cos = Math.cos(rot), sin = Math.sin(rot);
                points[k] = [];
                for (let de = 0; de < precision; de++) {
                    const i = de * Math.PI * 2 / precision;
                    const j = func(i) + r;
                    var x = Math.cos(i) * j, y = Math.sin(i) * j;
                    [x, y] = [cos * x - sin * y, sin * x + cos * y];
                    const txtX = numbertoSTL(x), txtY = numbertoSTL(y)
                    points[k][de] = [[x, y, z], `            vertex ${txtX} ${txtY} ${txtZ}`];
                }
            }
            console.log(points)
            return points
        }
        const txt0 = numbertoSTL(0);
        const txtm = numbertoSTL(-1);
        const txt1 = numbertoSTL(1);
        function toSTL() {
            const height = Number(inp_h.value);
            const precision_height = Number(inp_hp.value);
            const rotate_angle = Number(inp_a.value) * Math.PI / 180;
            var str = `solid gear\n`
            const t = "    ";
            const txtH = numbertoSTL(height);
            const middlePointUp = vertexText_xxx([txt0, txt0, txtH]);
            const middlePointDown = vertexText_xxx([txt0, txt0, txt0]);
            const points = get_points(height, rotate_angle, precision_height);
            for (let i = 0; i < precision_height; i++) {
                for (let j = 0; j < precision; j++) {
                    const P = points[i][j];
                    const Q = points[i + 1][j];
                    const R = points[i][(j + 1) % precision];
                    const S = points[i + 1][(j + 1) % precision];
                    str += `    facet normal ${normalVector(P[0], R[0], Q[0]).map(numbertoSTL).join(' ')}\n        outer loop\n${P[1]}\n${R[1]}\n${Q[1]}\n        endloop\n    endfacet\n`
                    str += `    facet normal ${normalVector(R[0], S[0], Q[0]).map(numbertoSTL).join(' ')}\n        outer loop\n${R[1]}\n${S[1]}\n${Q[1]}\n        endloop\n    endfacet\n`
                }
            }
            for (let j = 0; j < precision; j++) {
                const P = points[0][j];
                const Q = points[0][(j + 1) % precision];
                const R = points[precision_height][j];
                const S = points[precision_height][(j + 1) % precision];
                str += `    facet normal ${txt0} ${txt0} ${txtm}\n        outer loop\n${middlePointDown}\n${P[1]}\n${Q[1]}\n        endloop\n    endfacet\n`
                str += `    facet normal ${txt0} ${txt0} ${txt1}\n        outer loop\n${middlePointUp}\n${R[1]}\n${S[1]}\n        endloop\n    endfacet\n`
            }
            return str + `endsolid gear`
        }
        function crossProduct(v, u) { return [v[1] * u[2] - v[2] * u[1], v[2] * u[0] - v[0] * u[2], v[0] * u[1] - v[1] * u[0]] }
        function normalVector(A, B, C) { return crossProduct([A[0] - B[0], A[1] - B[1], A[2] - B[2]], [A[0] - C[0], A[1] - C[1], A[2] - C[2]]) }

        show_fn();
        run();


        onkeydown = (e) => {
            const { key, ctrlKey, shiftKey } = e;
            if (ctrlKey) {
                if (key.toLowerCase() === 's') {
                    e.preventDefault()
                    const a = document.createElement('a');
                    if (shiftKey) {
                        a.href = 'data:image/stl;utf-8,' + encodeURIComponent(toSTL());
                        a.download = `gear_T${teeth_N}S${teeth_S}.stl`;
                    } else {
                        a.href = 'data:text/svg+xml;utf-8,' + encodeURIComponent(svg.outerHTML);
                        a.download = `gear_T${teeth_N}S${teeth_S}.svg`;
                    }
                    a.click();
                }
            }
        }

        const inp_tN = $('#teethN');
        const inp_tS = $('#teethS');
        const inp_rad = $('#radius');
        const inp_f = $('#fn');
        const inp_p = $('#precision');
        const inp_h = $('#height');
        const inp_a = $('#angle');
        const inp_hp = $('#hprecision');
        inp_tN.onchange = function () { console.log(Number(inp_tN.value)); if (!isNaN(Number(inp_tN.value))) { teeth_N = Number(inp_tN.value); run(); show_fn(); } }
        inp_tS.onchange = function () { if (!isNaN(Number(inp_tS.value))) { teeth_S = Number(inp_tN.value); run(); } }
        inp_rad.onchange = function () { if (!isNaN(Number(inp_rad.value))) { r = Number(inp_tN.value); run(); } }
        inp_f.onkeydown = function ({ key }) { if (key === "Enter") { func = eval(inp_f.value); run(); show_fn(); } }
        inp_p.onchange = function () { if (!isNaN(Number(inp_rad.value))) { precision = Number(inp_p.value); run(); show_fn(); } }
    </script>
</body>

</html>
